{
    "name": "Momentum Sniper V19 (SMART ANALYST + HISTORY)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "momentum-trigger-new-v13",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-trigger",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                220,
                340
            ],
            "webhookId": "momentum-trigger-new-v13"
        },
        {
            "parameters": {
                "dataType": "string",
                "value1": "={{ $json[\"body\"][\"type\"] }}",
                "rules": {
                    "rules": [
                        {
                            "value2": "PUMP_DETECTED"
                        },
                        {
                            "value2": "TRADE_RESULT",
                            "output": 1
                        },
                        {
                            "value2": "TRADE_PULSE",
                            "output": 2
                        }
                    ]
                }
            },
            "id": "switch-event",
            "name": "Switch Event",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 1,
            "position": [
                440,
                340
            ]
        },
        {
            "parameters": {
                "url": "http://momentum-scanner:3000/trade-history",
                "options": {}
            },
            "id": "read-trade-history",
            "name": "Read Trade History (V19)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                660,
                340
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "mode": "combine",
                "combinationMode": "mergeByPosition",
                "options": {}
            },
            "id": "merge-data",
            "name": "Merge News+Pump+History",
            "type": "n8n-nodes-base.merge",
            "typeVersion": 2,
            "position": [
                1900,
                340
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "prompt_template",
                            "value": "{\n  \"instruction\": \"ACT AS A CALCULATING CRYPTO WHALE ANALYST (V20). You have access to GLOBAL NEWS feeds and SOCIAL METRICS.\",\n  \"V20_RULES\": {\n    \"TIER_LOGIC\": {\n      \"TIER_7_9_CONFIRMED\": \"IF news found in Cointelegraph/CoinDesk/Decrypt -> STRONG BUY signal. Confidence 90+.\",\n      \"TIER_5_HYPE\": \"IF NO official news, BUT LunarCrush Social Volume jumped >50% -> SPECULATIVE BUY (Hype). Confidence 75-80.\",\n      \"TIER_0_SILENT_WHALE\": \"IF NO news AND NO social hype, BUT Volume > $2M and History shows wins -> SILENT WHALE MODE. Buy with Confidence 85.\"\n    },\n    \"HISTORY_CHECK\": \"ALWAYS cross-reference with 'trade_history_stats'. Only approve TIER 0 if recent history has >50% win rate.\"\n  },\n  \"context\": \"Asset: {{ $json.body.pair }} | Change: {{ $json.body.change_percent }}% | Vol: {{ $json.body.volume_24h }}\",\n  \"news_data\": \"{{ $json.news_context.replace(/\\\"/g, \\\"'\\\") }}\",\n  \"social_data\": \"Social Hype Present: {{ $json.has_social_hype }}\",\n  \"trade_history\": \"{{ $json.trade_history_stats }}\",\n  \"recent_trades\": \"{{ ($json.recent_history || 'None').substring(0, 1000) }}\",\n  \"output_format\": \"ONLY JSON: { 'action': 'BUY/BLOCK', 'confidence': 0-100, 'tier': 0-10, 'mode': 'SCALP/MOON', 'reason': 'Cite source (CoinDesk/Lunar/History)' }\"\n}"
                        }
                    ]
                }
            },
            "id": "set-prompt-v19",
            "name": "Set Prompt (V20 Multi-Source)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                2100,
                340
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpQueryAuth",
                "sendBody": true,
                "contentType": "json",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "contents",
                            "value": "={{ [{\"parts\": [{\"text\": $json.prompt_template}]}] }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "gemini-catalyst",
            "name": "Consult Gemini (Catalyst)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                2300,
                340
            ]
        },
        {
            "parameters": {
                "jsCode": "// V19.1: Parse Gemini Response + Silent Whale Override + DIAGNOSTICS\nconst signal = $node[\"Webhook\"].json.body;\nconst geminiRaw = $json.candidates[0].content.parts[0].text;\n\n// DIAGNOSTICS: Check health of upstream nodes\nconst diagnostics = {\n    news_source: \"Google News RSS\",\n    news_status: \"âœ… OK\",\n    history_status: \"âœ… OK\", \n    data_quality: 100,\n    timestamp: new Date().toISOString()\n};\n\n// 1. Check News Health\ntry {\n    // Access the prompt from the prompt node\n    // Note: If Set Prompt exists, it formatted the news text.\n    // We check if the prompt contains the \"No major news\" fallback.\n    // Accessing previous node data via $node[\"Node Name\"]\n    const promptInput = $node[\"Set Prompt (V19 Reflection)\"].json.prompt_template;\n    \n    if (promptInput.includes(\"No major news search\") || promptInput.includes(\"No major news found\")) {\n        diagnostics.news_status = \"âš ï¸ NO NEWS FOUND (Google Empty)\";\n        diagnostics.data_quality -= 20;\n    } else if (promptInput.includes(\"Error processing news\")) {\n        diagnostics.news_status = \"âŒ NEWS ERROR\";\n        diagnostics.data_quality -= 40;\n    }\n} catch (e) {\n    diagnostics.news_status = \"â“ UNKNOWN (Check Node)\";\n}\n\n// 2. Check History Health\ntry {\n    // Check output of Read Trade History node\n    const historyData = $node[\"Read Trade History (V19)\"].json;\n    \n    if (!historyData || historyData.total_trades === undefined) {\n         diagnostics.history_status = \"âŒ HISTORY READ FAILED\";\n         diagnostics.data_quality -= 30;\n    } else if (historyData.total_trades === 0) {\n         diagnostics.history_status = \"âš ï¸ HISTORY EMPTY (0 trades)\";\n         diagnostics.data_quality -= 10;\n    } else {\n         diagnostics.history_status = `âœ… ACTIVE (${historyData.total_trades} trades)`;\n    }\n} catch (e) {\n    diagnostics.history_status = \"â“ HISTORY DATA UNAVAILABLE\";\n}\n\n// Remove markdown\nlet cleanResponse = geminiRaw.trim().replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n\nlet geminiDecision;\ntry {\n  geminiDecision = JSON.parse(cleanResponse);\n} catch (e) {\n  console.error('[V19] JSON Parse Error:', e.message);\n  return [{\n    json: {\n      action: 'BLOCK',\n      reason: 'AI Response Error (Non-JSON)',\n      confidence: 0,\n      mode: 'SCALP',\n      news_score: 0,\n      predicted_optimal_exit: 15,\n      system_diagnostics: diagnostics\n    }\n  }];\n}\n\n// Attach Diagnostics to Final Output\ngeminiDecision.system_diagnostics = diagnostics;\n\n// SILENT WHALE OVERRIDE\nif (signal.volume_24h > 2500000 && \n    geminiDecision.action === 'BLOCK' &&\n    (!geminiDecision.news_score || geminiDecision.news_score === 0)) {\n  \n  console.log(`ðŸ‹ [SILENT WHALE OVERRIDE] ${signal.pair} - $${(signal.volume_24h/1000000).toFixed(1)}M volume`);\n  \n  return [{\n    json: {\n      action: 'BUY',\n      reason: 'ðŸ‹ SILENT WHALE: High volume override (tight SL)',\n      confidence: 85,\n      mode: 'SCALP',\n      news_score: 0,\n      predicted_optimal_exit: 12,\n      whale_override: true,\n      system_diagnostics: diagnostics\n    }\n  }];\n}\n\n// Pass through original Gemini decision with diagnostics\nreturn [{ json: geminiDecision }];"
            },
            "id": "parse-and-whale-check",
            "name": "Parse + Silent Whale Override (V19)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                2500,
                340
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {}
            },
            "id": "webhook-response-pump",
            "name": "Respond (Pump Analysis)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                2700,
                340
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "prompt_template",
                            "value": "RE-EVALUATION PULSE (HYBRID):\nPair: {{ $json.body.pair }}\nPnL: {{ $json.body.pnl }}%\n\nShould I HOLD or EXIT?\nIf price is dropping and confidence is low, say EXIT.\nIf price is stable/rising, say HOLD.\n\nReply ONLY JSON:\n{ \"action\": \"HOLD\", \"confidence\": 90 }\nOR\n{ \"action\": \"EXIT\", \"confidence\": 90 }"
                        }
                    ]
                }
            },
            "id": "pulse-config",
            "name": "Set Config (Pulse)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                1900,
                540
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpQueryAuth",
                "sendBody": true,
                "contentType": "json",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "contents",
                            "value": "={{ [{\"parts\": [{\"text\": $json.prompt_template}]}] }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "gemini-pulse",
            "name": "Consult Gemini (Pulse)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                2100,
                540
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ JSON.parse($json[\"candidates\"][0][\"content\"][\"parts\"][0][\"text\"].replace(/```json/g, \"\").replace(/```/g, \"\")) }}",
                "options": {}
            },
            "id": "webhook-response-pulse",
            "name": "Respond (Pulse)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                2500,
                540
            ]
        },
        {
            "parameters": {
                "url": "https://cointelegraph.com/rss"
            },
            "id": "rss-cointelegraph",
            "name": "RSS Cointelegraph",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                0
            ]
        },
        {
            "parameters": {
                "url": "https://www.coindesk.com/arc/outboundfeeds/rss/"
            },
            "id": "rss-coindesk",
            "name": "RSS Coindesk",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                150
            ]
        },
        {
            "parameters": {
                "url": "https://decrypt.co/feed"
            },
            "id": "rss-decrypt",
            "name": "RSS Decrypt",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://cryptoslate.com/feed/"
            },
            "id": "rss-cryptoslate",
            "name": "RSS CryptoSlate",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                450
            ]
        },
        {
            "parameters": {
                "url": "={{ 'https://lunarcrush.com/api3/coins/' + $json.body.pair.replace('-USD','') }}",
                "options": {
                    "response": {
                        "response": {
                            "fullResponse": false
                        }
                    }
                },
                "headerParametersUi": {
                    "parameter": [
                        {
                            "name": "Authorization",
                            "value": "Bearer YOUR_LUNAR_API_KEY"
                        }
                    ]
                }
            },
            "id": "api-lunarcrush",
            "name": "LunarCrush (Social)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                900,
                600
            ]
        },
        {
            "parameters": {
                "url": "={{ 'https://news.google.com/rss/search?q=' + $json.body.pair.replace('-USD','') + '+crypto+when:1d&hl=en-US&gl=US&ceid=US:en' }}"
            },
            "id": "rss-google",
            "name": "Google News RSS",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                750
            ]
        },
        {
            "parameters": {
                "jsCode": "// V20 NEWS AGGREGATOR\nconst params = $('Webhook').first().json.body;\nconst pair = params.pair.replace('-USD', '');\n\nconst getFeed = (nodeName) => {\n    try {\n        // n8n returns a list of items. We want the JSON content.\n        // RSS Feed Read node outputs items with 'title', 'link', 'contentSnippet' etc.\n        return $items(nodeName).map(i => i.json);\n    } catch (e) { return []; }\n};\n\nconst ct = getFeed('RSS Cointelegraph');\nconst cd = getFeed('RSS Coindesk');\nconst dc = getFeed('RSS Decrypt');\nconst cs = getFeed('RSS CryptoSlate');\nconst gn = getFeed('Google News RSS');\nconst lunar = getFeed('LunarCrush (Social)')[0] || {};\n\nlet allNews = [];\n\n// Helper to filter news for our coin\nconst filterNews = (source, items) => {\n    return items.filter(i => {\n        const title = (i.title || '').toLowerCase();\n        const desc = (i.content || i.contentSnippet || i.description || '').toLowerCase();\n        const coin = pair.toLowerCase();\n        return title.includes(coin) || desc.includes(coin);\n    }).map(i => `[${source}] ${i.title}`);\n};\n\nallNews.push(...filterNews('CoinTelegraph', ct));\nallNews.push(...filterNews('CoinDesk', cd));\nallNews.push(...filterNews('Decrypt', dc));\nallNews.push(...filterNews('CryptoSlate', cs));\nallNews.push(...filterNews('GoogleNews', gn));\n\n// Social Data\nlet socialText = 'No LunarCrush Data';\nlet hasHype = false;\nif (lunar && lunar.data) {\n    const s = lunar.data;\n    socialText = `Social Vol: ${s.social_volume || 0} | Rank: ${s.alt_rank || 0}`;\n    if (s.social_volume_calc_24h_percent > 50) hasHype = true;\n}\n\nconst finalContext = allNews.length > 0 \n    ? allNews.slice(0, 15).join('\\n') \n    : 'No direct news found in major sources.';\n\nreturn [{\n    json: {\n        news_context: finalContext + '\\n\\n' + socialText,\n        news_count: allNews.length,\n        has_social_hype: hasHype\n    }\n}];"
            },
            "id": "news-aggregator-v20",
            "name": "Aggregator (V20)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                2100,
                340
            ]
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Switch Event",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch Event": {
            "main": [
                [
                    {
                        "node": "Read Trade History (V19)",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "RSS Cointelegraph",
                        "type": "main",
                        "index": 0
                    }
                ],
                [],
                [
                    {
                        "node": "Set Config (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Read Trade History (V19)": {
            "main": [
                [
                    {
                        "node": "Merge News+Pump+History",
                        "type": "main",
                        "index": 2
                    }
                ]
            ]
        },
        "Merge News+Pump+History": {
            "main": [
                [
                    {
                        "node": "Set Prompt (V20 Multi-Source)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Prompt (V19 Reflection)": {
            "main": [
                [
                    {
                        "node": "Consult Gemini (Catalyst)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Consult Gemini (Catalyst)": {
            "main": [
                [
                    {
                        "node": "Parse + Silent Whale Override (V19)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse + Silent Whale Override (V19)": {
            "main": [
                [
                    {
                        "node": "Respond (Pump Analysis)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Config (Pulse)": {
            "main": [
                [
                    {
                        "node": "Consult Gemini (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Consult Gemini (Pulse)": {
            "main": [
                [
                    {
                        "node": "Respond (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Cointelegraph": {
            "main": [
                [
                    {
                        "node": "RSS Coindesk",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Coindesk": {
            "main": [
                [
                    {
                        "node": "RSS Decrypt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Decrypt": {
            "main": [
                [
                    {
                        "node": "RSS CryptoSlate",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS CryptoSlate": {
            "main": [
                [
                    {
                        "node": "LunarCrush (Social)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "LunarCrush (Social)": {
            "main": [
                [
                    {
                        "node": "Google News RSS",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google News RSS": {
            "main": [
                [
                    {
                        "node": "Aggregator (V20)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Aggregator (V20)": {
            "main": [
                [
                    {
                        "node": "Merge News+Pump+History",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}