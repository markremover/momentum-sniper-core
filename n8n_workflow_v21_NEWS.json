{
    "name": "Momentum Sniper V21.1 (PARALLEL + SYNC)",
    "nodes": [
        {
            "parameters": {
                "httpMethod": "POST",
                "path": "momentum-trigger-new-v13",
                "responseMode": "responseNode",
                "options": {}
            },
            "id": "webhook-trigger",
            "name": "Webhook",
            "type": "n8n-nodes-base.webhook",
            "typeVersion": 1,
            "position": [
                220,
                340
            ],
            "webhookId": "momentum-trigger-new-v13"
        },
        {
            "parameters": {
                "dataType": "string",
                "value1": "={{ $json[\"body\"][\"type\"] }}",
                "rules": {
                    "rules": [
                        {
                            "value2": "PUMP_DETECTED"
                        },
                        {
                            "value2": "TRADE_RESULT",
                            "output": 1
                        },
                        {
                            "value2": "TRADE_PULSE",
                            "output": 2
                        }
                    ]
                }
            },
            "id": "switch-event",
            "name": "Switch Event",
            "type": "n8n-nodes-base.switch",
            "typeVersion": 1,
            "position": [
                440,
                340
            ]
        },
        {
            "parameters": {
                "url": "http://momentum-scanner:3000/trade-history",
                "options": {}
            },
            "id": "read-trade-history",
            "name": "Read Trade History (V21)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                660,
                200
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "https://cointelegraph.com/rss"
            },
            "id": "rss-cointelegraph",
            "name": "RSS Cointelegraph",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                100
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "https://www.coindesk.com/arc/outboundfeeds/rss/"
            },
            "id": "rss-coindesk",
            "name": "RSS Coindesk",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                1100,
                100
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "https://decrypt.co/feed"
            },
            "id": "rss-decrypt",
            "name": "RSS Decrypt",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                1300,
                100
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "https://cryptoslate.com/feed/"
            },
            "id": "rss-cryptoslate",
            "name": "RSS CryptoSlate",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                900,
                400
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "={{ 'https://lunarcrush.com/api3/coins/' + $('Webhook').first().json.body.pair.replace('-USD','') }}",
                "headerParametersUi": {
                    "parameter": [
                        {
                            "name": "Authorization",
                            "value": "Bearer {{$env.LUNARCRUSH_API_KEY}}"
                        }
                    ]
                }
            },
            "id": "api-lunarcrush",
            "name": "LunarCrush (Social)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                1100,
                400
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "={{ 'https://news.google.com/rss/search?q=' + $('Webhook').first().json.body.pair.replace('-USD','') + '+crypto+when:1d&hl=en-US&gl=US&ceid=US:en' }}"
            },
            "id": "rss-google",
            "name": "Google News RSS",
            "type": "n8n-nodes-base.rssFeedRead",
            "typeVersion": 1,
            "position": [
                1300,
                400
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "jsCode": "// V21.2 STRICT TRUTH AGGREGATOR\nconst params = $('Webhook').first().json.body;\nconst pair = params.pair.replace('-USD', '');\n\nconst getFeed = (nodeName) => {\n    try {\n        const items = $items(nodeName).map(i => i.json);\n        return items.filter(i => !i.error && !i.status_code && i.title);\n    } catch (e) { return []; }\n};\n\nconst ct = getFeed('RSS Cointelegraph');\nconst cd = getFeed('RSS Coindesk');\nconst dc = getFeed('RSS Decrypt');\nconst cs = getFeed('RSS CryptoSlate');\nconst gn = getFeed('Google News RSS');\n\nlet lunar = {};\ntry {\n    if ($items('LunarCrush (Social)').length > 0) {\n        lunar = $items('LunarCrush (Social)')[0].json;\n    }\n} catch (e) {\n    lunar = {};\n}\n\nlet allNews = [];\n\n// FIX: STRICT REGEX (No partial matches)\nconst filterNews = (source, items) => {\n    return items.filter(i => {\n        const title = (i.title || '').toLowerCase();\n        const desc = (i.content || i.contentSnippet || i.description || '').toLowerCase();\n        // STRICT REGEX: Word boundary check\n        const regex = new RegExp(`\\\\b${pair.toLowerCase()}\\\\b`, 'i');\n        return regex.test(title) || regex.test(desc);\n    }).map(i => `[${source}] ${i.title}`);\n};\n\nallNews.push(...filterNews('CoinTelegraph', ct));\nallNews.push(...filterNews('CoinDesk', cd));\nallNews.push(...filterNews('Decrypt', dc));\nallNews.push(...filterNews('CryptoSlate', cs));\nallNews.push(...filterNews('GoogleNews', gn));\n\n// Social Data\nlet socialText = 'No LunarCrush Data';\nlet hasHype = false;\nif (lunar && lunar.data) {\n    const s = lunar.data;\n    socialText = `Social Vol: ${s.social_volume || 0} | Rank: ${s.alt_rank || 0}`;\n    if (s.social_volume_calc_24h_percent > 50) hasHype = true;\n}\n\n// V21.2: STRICT CONTEXT\nconst finalContext = allNews.length > 0 \n    ? allNews.slice(0, 15).join('\\n') \n    : 'NO_NEWS_FOUND';\n\n// Extract unique sources for debugging\nconst uniqueSources = [...new Set(allNews.map(i => {\n    const match = i.match(/^\\\\[(.*?)\\\\]/);\n    return match ? match[1] : null;\n}).filter(Boolean))].join(', ');\n\nreturn [{\n    json: {\n        news_context: finalContext + '\\n\\n' + socialText,\n        news_count: allNews.length,\n        news_sources: uniqueSources || \"None\", // Explicit list of found sources\n        found_sources: uniqueSources || \"None\", // Helper alias\n        has_social_hype: hasHype\n    }\n}];"
            },
            "id": "news-aggregator-v21",
            "name": "Aggregator (V21)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                1700,
                340
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "prompt_template",
                            "value": "{\n  \"instruction\": \"ACT AS A CALCULATING CRYPTO WHALE ANALYST (V21). You have access to GLOBAL NEWS feeds and SOCIAL METRICS.\",\n  \"STRICT_GROUNDING\": {\n      \"RULE_1\": \"USE ONLY THE TEXT PROVIDED IN 'news_data'.\",\n      \"RULE_2\": \"IF 'news_data' contains 'NO_NEWS_FOUND', YOU MUST NOT MENTION ANY NEWS SOURCES (Cointelegraph, CoinDesk, etc) AS 'SOURCES'.\",\n      \"RULE_3\": \"IF NO NEWS: State 'NO REAL-TIME NEWS DETECTED'.\",\n      \"RULE_4\": \"HALLUCINATION PENALTY: If you invent news not in the context, set Confidence = 0.\"\n  },\n  \"V21_RULES\": {\n    \"SCORING_LOGIC\": {\n      \"SCORE_7_9_CONFIRMED\": \"IF news found in context -> STRONG BUY signal. Confidence 90+.\",\n      \"SCORE_5_HYPE\": \"IF NO official news, BUT LunarCrush Social Volume jumped >50% -> SPECULATIVE BUY (Hype). Confidence 75-80.\",\n      \"SCORE_0_SILENT_WHALE\": \"IF news_context == 'NO_NEWS_FOUND' BUT Volume is High / History Good -> ACTION: BUY. news_score: 0. Reason: 'Silent Whale Accumulation'. RECOMMEND: 50% Size.\"\n    },\n    \"HISTORY_CHECK\": \"ALWAYS cross-reference with 'trade_history_stats'. IF history is UNAVAILABLE, write 'History unknown, proceed with caution' in reason.\"\n  },\n  \"context\": \"Asset: {{ $json.body.pair }} | Change: {{ $json.body.change_percent }}% | Vol: {{ $json.body.volume_24h }}\",\n  \"news_data\": \"{{ $json.news_context.replace(/\\\"/g, \\\"'\\\") }}\",\n  \"social_data\": \"Social Hype Present: {{ $json.has_social_hype }}\",\n  \"trade_history\": \"{{ $json.trade_history_stats }}\",\n  \"recent_trades\": \"{{ ($json.recent_history || 'None').substring(0, 1000) }}\",\n  \"output_format\": \"ONLY JSON: { 'action': 'BUY/BLOCK', 'confidence': 0-100, 'news_score': 0-10, 'mode': 'SCALP/MOON', 'reason': 'Cite source or 'Silent Whale' if no news' }\"\n}"
                        }
                    ]
                }
            },
            "id": "set-prompt-v21",
            "name": "Set Prompt (V21 Multi-Source)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                1900,
                340
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpQueryAuth",
                "sendBody": true,
                "contentType": "json",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "contents",
                            "value": "={{ [{\"parts\": [{\"text\": $json.prompt_template}]}] }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "gemini-catalyst",
            "name": "Consult Gemini (Catalyst)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                2100,
                340
                "jsCode": "// V21.2: Parse Gemini Response + GREEN DIAGNOSTICS + SYNC FIX\nconst signal = $node[\"Webhook\"].json.body;\nconst geminiRaw = $json.candidates[0].content.parts[0].text;\n\n// DIAGNOSTICS\nconst diagnostics = {\n    news_source: \"Google/Combiner\",\n    news_status: \"❓ CHECKING\",\n    history_status: \"❓ CHECKING\", \n    data_quality: 100,\n    timestamp: new Date().toISOString()\n};\n\n// 1. Check News Health (Real Check)\ntry {\n    const aggData = $node[\"Aggregator (V21)\"].json;\n    if (aggData.news_count > 0) {\n        diagnostics.news_status = `✅ OK (${aggData.news_count} items)`;\n        diagnostics.found_sources = aggData.found_sources; // V21.2 Add found sources\n    } else {\n        diagnostics.news_status = \"⚠️ EMPTY (No News Found)\";\n        diagnostics.found_sources = \"None\"; \n        diagnostics.data_quality -= 20;\n    }\n} catch (e) {\n    diagnostics.news_status = \"❌ AGGREGATOR ERROR\";\n}\n\n// 2. Check History Health (Real Check)\ntry {\n    const historyData = $node[\"Read Trade History (V21)\"].json;\n    if (historyData && historyData.total_trades !== undefined) {\n         diagnostics.history_status = `✅ OK (${historyData.total_trades} trades)`;\n    } else {\n         diagnostics.history_status = \"❌ HISTORY ERROR\";\n         diagnostics.data_quality -= 30;\n    }\n} catch (e) {\n    diagnostics.history_status = \"❓ UNKNOWN\";\n}\n\n// Remove markdown\nlet cleanResponse = geminiRaw.trim().replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n\nlet geminiDecision;\ntry {\n  geminiDecision = JSON.parse(cleanResponse);\n} catch (e) {\n  console.error('[V21] JSON Parse Error:', e.message);\n  return [{\n    json: {\n      action: 'BLOCK',\n      reason: 'AI Response Error (Non-JSON)',\n      confidence: 0,\n      mode: 'SCALP',\n      news_score: 0,\n      predicted_optimal_exit: 15,\n      system_diagnostics: diagnostics\n    }\n  }];\n}\n\n// STANDARD: Force news_score field\nif (geminiDecision.tier !== undefined && geminiDecision.news_score === undefined) {\n    geminiDecision.news_score = geminiDecision.tier;\n}\n\n// Attach Diagnostics & Sources\ngeminiDecision.system_diagnostics = diagnostics;\ntry {\n   geminiDecision.news_sources = $node[\"Aggregator (V21)\"].json.news_sources;\n} catch (e) {\n   geminiDecision.news_sources = \"Unknown\";\n}\n\nreturn [{ json: geminiDecision }];"
            },
            "id": "parse-and-whale-check",
            "name": "Parse + Silent Whale Override (V21)",
            "type": "n8n-nodes-base.code",
            "typeVersion": 1,
            "position": [
                2300,
                340
            ]
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ $json }}",
                "options": {}
            },
            "id": "webhook-response-pump",
            "name": "Respond (Pump Analysis)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                2500,
                340
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "prompt_template",
                            "value": "RE-EVALUATION PULSE (HYBRID):\nPair: {{ $json.body.pair }}\nPnL: {{ $json.body.pnl }}%\n..."
                        }
                    ]
                }
            },
            "id": "pulse-config",
            "name": "Set Config (Pulse)",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                1900,
                540
            ]
        },
        {
            "parameters": {
                "method": "POST",
                "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
                "authentication": "genericCredentialType",
                "genericAuthType": "httpQueryAuth",
                "sendBody": true,
                "contentType": "json",
                "bodyParameters": {
                    "parameters": [
                        {
                            "name": "contents",
                            "value": "={{ [{\"parts\": [{\"text\": $json.prompt_template}]}] }}"
                        }
                    ]
                },
                "options": {}
            },
            "id": "gemini-pulse",
            "name": "Consult Gemini (Pulse)",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 3,
            "position": [
                2100,
                540
            ],
            "continueOnFail": true
        },
        {
            "parameters": {
                "respondWith": "json",
                "responseBody": "={{ JSON.parse($json[\"candidates\"][0][\"content\"][\"parts\"][0][\"text\"].replace(/```json/g, \"\").replace(/```/g, \"\")) }}",
                "options": {}
            },
            "id": "webhook-response-pulse",
            "name": "Respond (Pulse)",
            "type": "n8n-nodes-base.respondToWebhook",
            "typeVersion": 1,
            "position": [
                2500,
                540
            ]
        }
    ],
    "connections": {
        "Webhook": {
            "main": [
                [
                    {
                        "node": "Switch Event",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Switch Event": {
            "main": [
                [
                    {
                        "node": "Read Trade History (V21)",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "RSS Cointelegraph",
                        "type": "main",
                        "index": 0
                    },
                    {
                        "node": "RSS CryptoSlate",
                        "type": "main",
                        "index": 0
                    }
                ],
                [],
                [
                    {
                        "node": "Set Config (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Cointelegraph": {
            "main": [
                [
                    {
                        "node": "RSS Coindesk",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Coindesk": {
            "main": [
                [
                    {
                        "node": "RSS Decrypt",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS Decrypt": {
            "main": [
                [
                    {
                        "node": "Aggregator (V21)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "RSS CryptoSlate": {
            "main": [
                [
                    {
                        "node": "LunarCrush (Social)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "LunarCrush (Social)": {
            "main": [
                [
                    {
                        "node": "Google News RSS",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Google News RSS": {
            "main": [
                [
                    {
                        "node": "Aggregator (V21)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Read Trade History (V21)": {
            "main": [
                [
                    {
                        "node": "Aggregator (V21)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Aggregator (V21)": {
            "main": [
                [
                    {
                        "node": "Set Prompt (V21 Multi-Source)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Prompt (V21 Multi-Source)": {
            "main": [
                [
                    {
                        "node": "Consult Gemini (Catalyst)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Consult Gemini (Catalyst)": {
            "main": [
                [
                    {
                        "node": "Parse + Silent Whale Override (V21)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Parse + Silent Whale Override (V21)": {
            "main": [
                [
                    {
                        "node": "Respond (Pump Analysis)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Set Config (Pulse)": {
            "main": [
                [
                    {
                        "node": "Consult Gemini (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Consult Gemini (Pulse)": {
            "main": [
                [
                    {
                        "node": "Respond (Pulse)",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    }
}